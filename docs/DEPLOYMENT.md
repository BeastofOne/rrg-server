# Deployment Guide

## Build Pipeline

All services use `Nix flake → Docker image → docker compose`:

```
flake.nix + pyproject.toml + poetry.lock → nix build → result (tarball) → docker load → docker compose up
```

Builds are `x86_64-linux` only. Build on rrg-server, not jake-macbook.

## rrg-pnl / rrg-brochure / rrg-router

```bash
ssh andrea@rrg-server
cd ~/rrg-server/rrg-pnl  # or rrg-brochure, rrg-router
nix build && docker load < result
cd ~/rrg-server/deploy && docker compose up -d
```

Env vars in `deploy/.env` (gitignored): `CLAUDE_CODE_OAUTH_TOKEN`, `CLAUDE_MODEL`, `USE_WINDMILL`, `WINDMILL_*`.
See `deploy/.env.example` for required variables.

## DocuSeal

Separate repo: `BeastofOne/docuseal` (fork of docusealco/docuseal, `rrg` branch).
DocuSeal v2.3.2 with 5 RRG customizations (auto-submit URL params, prefill fields, custom navbar, iframe embedding, no trilogy gem).

```bash
ssh andrea@rrg-server
cd ~/docuseal
nix build && docker load < result
docker compose down && docker compose up -d
```

### DocuSeal Version Bump Workflow
1. Update `fetchFromGitHub` rev/hash in `flake.nix`
2. `bundle lock` → update `Gemfile.lock`
3. `bundix -l` → regenerate `gemset.nix`
4. Verify customization files still apply
5. `nix build && docker load < result && docker compose down && docker compose up -d`

### DocuSeal Directory Structure
| File | Purpose |
|------|---------|
| `flake.nix` | Full Nix build pipeline (source → gems → assets → Docker) |
| `Gemfile` / `Gemfile.lock` | Patched (no trilogy gem) |
| `gemset.nix` | Generated by `bundix` — gem hashes for Nix |
| `customizations/` | 4 RRG overlay files (controllers, navbar, frame_options) |
| `docker-compose.yml` | Runtime config (ports, volumes, SMTP, env) |

### DocuSeal Nix Quirks
- `bundix` generates wrong hashes for platform-specific gems (ffi, nokogiri, sqlite3) — fix with `nix-prefetch-url`
- nokogiri needs `mini_portile2` added to gemset.nix (not in Gemfile.lock for platform-specific gems)

## rrg-claude-endpoint (pm2 on jake-macbook)

```bash
pm2 start server.js --name claude-endpoint
pm2 restart claude-endpoint
pm2 logs claude-endpoint
```

## Auto-Sync

Both jake-macbook and rrg-server run `rrg-sync.sh` on 5-minute cron:
- Stages all changes, commits if dirty, pulls with rebase, pushes
- Both machines stay within 5 minutes of sync
- Logs: `/tmp/rrg-sync.log`

Windmill flows sync hourly via `windmill/sync-pull.sh` cron on rrg-server.

## Windmill Disaster Recovery

Flows/scripts are version-controlled in `windmill/f/` (via `wmill sync pull`).
To restore to a fresh Windmill instance:
```bash
cd ~/rrg-server/windmill
wmill sync push --base-url http://localhost:8000 --workspace rrg --token <token>
```

## Docker Compose Files

| File | Purpose |
|------|---------|
| `deploy/docker-compose.yml` | rrg-pnl, rrg-brochure, rrg-router containers |
| `deploy/windmill-docker-compose.yml` | Windmill reference copy (disaster recovery) |
| `~/docuseal/docker-compose.yml` | DocuSeal (in separate fork repo) |
