%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#fff3e0', 'primaryTextColor': '#e65100', 'primaryBorderColor': '#fb8c00', 'lineColor': '#fb8c00'}}}%%

graph TB
    subgraph TRIGGERS["TRIGGERS"]
        T_CHAT["User opens chat UI<br/>(:8501)"]
        T_NDA["Jake sends NDA<br/>(via Claude Code)"]
        T_SIGN["Recipient signs NDA<br/>(DocuSeal webhook)"]
        T_SCHED["Windmill scheduled job"]
        T_GMAIL["Gmail push notification<br/>(Pub/Sub)"]
    end

    subgraph CHAT_FLOW["CHAT FLOW"]
        ROUTER["jake-router<br/>receives message"]
        ROUTE{{"Route by<br/>target_node"}}
        PNL["jake-pnl<br/>P&L analysis"]
        BROCHURE["jake-brochure<br/>Brochure generation"]
        WM_MSG["Windmill<br/>message_router"]
    end

    subgraph NDA_FLOW["NDA FLOW"]
        DS_CREATE["DocuSeal creates submission<br/>Template: NCND-RRG"]
        DS_EMAIL["Signing link emailed<br/>(teamgotcher SMTP)"]
        DS_SIGN["Recipient signs"]
        DS_HOOK["DocuSeal webhook fires"]
        DS_HANDLER["Windmill<br/>docuseal_nda/completed"]
    end

    subgraph SWITCHBOARD["WINDMILL SWITCHBOARD"]
        LEAD["lead_intake<br/>Process incoming leads"]
        SIG_W["write_signal"]
        SIG_R["read_signals"]
        SIG_A["act_signal"]
        GMAIL_WH["gmail_pubsub_webhook"]
        GMAIL_WATCH["setup_gmail_watch<br/>(renew every 6 days)"]
    end

    subgraph EXTERNAL["EXTERNAL SERVICES"]
        HUBSPOT["HubSpot CRM"]
        CLAUDE["Anthropic API"]
        GMAIL_API["Gmail API"]
    end

    %% Chat flow
    T_CHAT --> ROUTER --> ROUTE
    ROUTE -->|"pnl"| PNL
    ROUTE -->|"brochure"| BROCHURE
    ROUTE -->|"windmill"| WM_MSG
    PNL --> CLAUDE
    BROCHURE --> CLAUDE

    %% NDA flow
    T_NDA --> DS_CREATE --> DS_EMAIL --> DS_SIGN
    T_SIGN --> DS_HOOK
    DS_SIGN --> DS_HOOK
    DS_HOOK --> DS_HANDLER --> HUBSPOT

    %% Windmill flows
    T_SCHED --> LEAD --> HUBSPOT
    T_GMAIL --> GMAIL_WH --> SIG_W

    %% Signal pipeline
    SIG_W --> SIG_R --> SIG_A

    %% Gmail watch
    GMAIL_WATCH --> GMAIL_API

    %% Styling
    style TRIGGERS fill:#e3f2fd,stroke:#42a5f5
    style EXTERNAL fill:#f3e5f5,stroke:#ab47bc
    style SWITCHBOARD fill:#e8f5e9,stroke:#66bb6a
    style NDA_FLOW fill:#fce4ec,stroke:#ef5350
    style CHAT_FLOW fill:#fff3e0,stroke:#ffb300
