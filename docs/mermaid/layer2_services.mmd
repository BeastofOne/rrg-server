%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e8f5e9', 'primaryTextColor': '#1b5e20', 'primaryBorderColor': '#43a047', 'lineColor': '#43a047'}}}%%

graph TB
    subgraph RRG["RRG-SERVER (100.97.86.99)"]
        direction TB

        subgraph FUNNEL["Tailscale Funnel — Public HTTPS"]
            F_DS["rrg-server.tailc01f9b.ts.net<br/>→ DocuSeal :3000"]
            F_WM["rrg-server.tailc01f9b.ts.net:8443<br/>→ Windmill :8000"]
        end

        subgraph JAKE_APPS["jake-deploy (docker-compose.jake.yml)"]
            ROUTER["<b>rrg-router</b><br/>:8501 — Streamlit chat UI"]
            PNL["<b>rrg-pnl</b><br/>:8100 — P&L worker"]
            BROCHURE["<b>rrg-brochure</b><br/>:8101 — Brochure worker"]
        end

        subgraph WM_STACK["windmill (docker-compose.yml)"]
            WM_SERVER["<b>windmill-server</b><br/>:8000 — Workflow engine"]
            WM_WORKER["<b>windmill-worker</b><br/>Job executor"]
            WM_DB["<b>postgres</b><br/>:5432 — Windmill DB"]
        end

        subgraph DS_STACK["docuseal (docker-compose.yml)"]
            DOCUSEAL["<b>docuseal</b><br/>:3000 — NDA signing"]
        end
    end

    subgraph MAC["JAKE'S MAC (100.108.74.112)"]
        CLAUDE_CLI["<b>Claude Code</b><br/>Interactive terminal"]
        CLAUDE_EP["<b>claude-endpoint</b><br/>:8787 (pm2)"]
        MCP_HS["HubSpot MCP"]
        MCP_WM["Windmill MCP"]
    end

    subgraph LARRY["LARRY'S MAC (100.79.238.103)"]
        SMS_GW["<b>SMS Gateway</b><br/>:8080"]
    end

    subgraph CLOUD["CLOUD SERVICES"]
        HUBSPOT["HubSpot API"]
        GMAIL["Gmail SMTP"]
        ANTHROPIC["Anthropic API"]
    end

    %% Funnel routing
    F_DS --> DOCUSEAL
    F_WM --> WM_SERVER

    %% Jake apps internal routing
    ROUTER --> PNL
    ROUTER --> BROCHURE
    ROUTER --> WM_SERVER

    %% All jake apps → Anthropic
    ROUTER --> ANTHROPIC
    PNL --> ANTHROPIC
    BROCHURE --> ANTHROPIC

    %% Windmill internals
    WM_SERVER --> WM_DB
    WM_WORKER --> WM_DB

    %% DocuSeal → Gmail
    DOCUSEAL --> GMAIL

    %% Claude CLI MCP connections
    CLAUDE_CLI --> MCP_HS
    CLAUDE_CLI --> MCP_WM
    MCP_HS --> HUBSPOT
    MCP_WM -->|"via Tailscale"| WM_SERVER

    %% Styling
    style FUNNEL fill:#fff8e1,stroke:#ffb300
    style CLOUD fill:#f3e5f5,stroke:#ab47bc
    style JAKE_APPS fill:#e3f2fd,stroke:#42a5f5
    style WM_STACK fill:#e8f5e9,stroke:#66bb6a
    style DS_STACK fill:#fce4ec,stroke:#ef5350
